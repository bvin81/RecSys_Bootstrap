<!-- ===== templates/base.html ===== -->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}GreenRec Aj√°nl√≥rendszer{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* GLOB√ÅLIS BODY STYLING - gradient h√°tt√©r minden oldalon */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .score-badge { font-size: 0.8em; margin: 2px; }
        .explanation-box { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .recipe-card { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .group-indicator { position: fixed; top: 10px; right: 10px; background-color: #007bff; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; }
    </style>
</head>
<body>
    {% if session.group %}
    <div class="group-indicator">Tesztcsoport: {{ session.group }}</div>
    {% endif %}
    
    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {% for message in messages %}
                        {{ message }}
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}

    <!-- Add hozz√° a base.html v√©g√©re, a </body> tag EL≈êTT: -->

    <script>
        // ===== JAV√çTOTT GLOB√ÅLIS K√âP FALLBACK FUNKCI√ì =====
    function getPlaceholderImage(category) {
        // Placeholder.pics haszn√°lata - megb√≠zhat√≥ √©s ingyenes
        const placeholders = {
            'F≈ë√©telek': 'https://picsum.photos/300/200?random=1',
            'F≈ë√©tel': 'https://picsum.photos/300/200?random=2',
            'Sal√°t√°k': 'https://picsum.photos/300/200?random=3',
            'Sal√°ta': 'https://picsum.photos/300/200?random=4',
            'Levesek': 'https://picsum.photos/300/200?random=5',
            'Leves': 'https://picsum.photos/300/200?random=6',
            'Desszertek': 'https://picsum.photos/300/200?random=7',
            'Desszert': 'https://picsum.photos/300/200?random=8',
            'Sert√©s': 'https://picsum.photos/300/200?random=9',
            'Marhah√∫s': 'https://picsum.photos/300/200?random=10',
            'Csirke': 'https://picsum.photos/300/200?random=11',
            'Hal': 'https://picsum.photos/300/200?random=12',
            'Veget√°ri√°nus': 'https://picsum.photos/300/200?random=13',
            'T√©sztaf√©l√©k': 'https://picsum.photos/300/200?random=14',
            'T√©sztaf≈ëz√©rek': 'https://picsum.photos/300/200?random=15',
            'Rizs': 'https://picsum.photos/300/200?random=16',
            'Feh√©r rizs': 'https://picsum.photos/300/200?random=17',
            'Egyt√°l√©tel': 'https://picsum.photos/300/200?random=18',
            'Snackek': 'https://picsum.photos/300/200?random=19',
            'Snack': 'https://picsum.photos/300/200?random=20'
        };
        
        return placeholders[category] || 'https://picsum.photos/300/200?random=21';
    }
    
    function handleImageError(img) {
        // Megakad√°lyozza a v√©gtelen loop-ot
        if (img.src.includes('picsum.photos') || img.hasAttribute('data-fallback-applied')) {
            return;
        }
        
        console.log(`üñºÔ∏è Hib√°s k√©p √©szlelve: ${img.src}`);
        
        // Kateg√≥ria meghat√°roz√°sa
        let category = '√Åltal√°nos';
        
        // 1. data-category attrib√∫tumb√≥l (legmegb√≠zhat√≥bb)
        if (img.hasAttribute('data-category')) {
            category = img.getAttribute('data-category');
        }
        // 2. Recept card-b√≥l keres√©s
        else {
            const recipeCard = img.closest('.recipe-card') || img.closest('.card') || img.closest('[class*="recipe"]');
            if (recipeCard) {
                // Keres√©s kateg√≥ria badge-ben
                const categoryBadge = recipeCard.querySelector('.badge') || 
                                     recipeCard.querySelector('[class*="category"]') ||
                                     recipeCard.querySelector('.text-muted');
                if (categoryBadge && categoryBadge.textContent.trim()) {
                    category = categoryBadge.textContent.trim();
                }
                
                // Ha nincs badge, pr√≥b√°ljuk a receptc√≠mb≈ël kital√°lni
                if (category === '√Åltal√°nos') {
                    const titleElement = recipeCard.querySelector('h5') || 
                                       recipeCard.querySelector('h4') || 
                                       recipeCard.querySelector('.card-title');
                    if (titleElement) {
                        const title = titleElement.textContent.toLowerCase();
                        if (title.includes('leves')) category = 'Levesek';
                        else if (title.includes('sal√°ta')) category = 'Sal√°t√°k';
                        else if (title.includes('desszert') || title.includes('s√ºti')) category = 'Desszertek';
                        else if (title.includes('t√©szta')) category = 'T√©sztaf√©l√©k';
                        else if (title.includes('h√∫s') || title.includes('sert√©s')) category = 'Sert√©s';
                        else if (title.includes('csirke')) category = 'Csirke';
                        else if (title.includes('hal')) category = 'Hal';
                        else category = 'F≈ë√©telek';
                    }
                }
            }
        }
        
        // 3. alt attrib√∫tumb√≥l utols√≥ es√©ly
        if (category === '√Åltal√°nos' && img.alt) {
            category = img.alt;
        }
        
        // Placeholder k√©p be√°ll√≠t√°sa
        const newSrc = getPlaceholderImage(category);
        img.src = newSrc;
        img.alt = `${category} recept (placeholder)`;
        
        // Megjel√∂l√©s hogy m√°r alkalmaztuk a fallback-et
        img.setAttribute('data-fallback-applied', 'true');
        
        // Vizu√°lis jelz√©s
        img.style.border = '2px dashed rgba(108, 117, 125, 0.3)';
        img.style.opacity = '0.85';
        
        console.log(`‚úÖ K√©p jav√≠tva: ${category} ‚Üí ${newSrc}`);
    }
    
    // Hib√°s URL-ek list√°ja (proakt√≠v ellen≈ërz√©shez)
    const KNOWN_BAD_DOMAINS = [
        'sndimg.com',
        'food.com',
        'broken',
        'error',
        'localhost',
        '127.0.0.1'
    ];
    
    function isLikelyBrokenUrl(url) {
        if (!url || url === '' || url === 'null' || url === 'undefined') return true;
        
        // HTTP helyett HTTPS probl√©ma
        if (url.startsWith('http://') && !url.includes('picsum.photos')) return true;
        
        // Ismert hib√°s domainek
        return KNOWN_BAD_DOMAINS.some(domain => url.includes(domain));
    }
    
    function protectImages() {
        const images = document.querySelectorAll('img');
        console.log(`üîç ${images.length} k√©p ellen≈ërz√©se...`);
        
        images.forEach(img => {
            // Skip ha m√°r v√©dett
            if (img.hasAttribute('data-protected')) return;
            
            // Error handler hozz√°ad√°sa
            img.onerror = () => handleImageError(img);
            img.setAttribute('data-protected', 'true');
            
            // Proakt√≠v ellen≈ërz√©s hib√°s URL-ekre
            if (img.src && isLikelyBrokenUrl(img.src)) {
                console.log(`‚ö†Ô∏è Proakt√≠v jav√≠t√°s: ${img.src}`);
                handleImageError(img);
            }
            
            // Load timeout - ha 5 m√°sodperc alatt nem t√∂lt≈ëdik be
            const loadTimeout = setTimeout(() => {
                if (!img.complete || img.naturalWidth === 0) {
                    console.log(`‚è∞ Timeout: ${img.src}`);
                    handleImageError(img);
                }
            }, 5000);
            
            // Ha bet√∂lt≈ëdik, t√∂rlj√ºk a timeout-ot
            img.onload = () => {
                clearTimeout(loadTimeout);
                // Ellen≈ërizz√ºk hogy val√≥ban valid k√©p-e
                if (img.naturalWidth === 0 || img.naturalHeight === 0) {
                    handleImageError(img);
                }
            };
        });
    }
    
    // DOM ready + dinamikus tartalom figyel√©se
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üñºÔ∏è Glob√°lis k√©p v√©delem aktiv√°l√°sa...');
        
        // Azonnali futtat√°s
        protectImages();
        
        // Dinamikus tartalom figyel√©se (AJAX aj√°nl√°sok)
        const observer = new MutationObserver(function(mutations) {
            let hasNewImages = false;
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) { // Element node
                            if (node.tagName === 'IMG' || node.querySelector('img')) {
                                hasNewImages = true;
                            }
                        }
                    });
                }
            });
            
            if (hasNewImages) {
                console.log('üîÑ √öj k√©pek √©szlelve, v√©delem alkalmaz√°sa...');
                setTimeout(protectImages, 100); // Kis k√©sleltet√©s hogy a DOM friss√ºlj√∂n
            }
        });
        
        // Figyelj√ºk a DOM v√°ltoz√°sokat
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        console.log('‚úÖ Glob√°lis k√©p v√©delem aktiv√°lva');
    });
    
    // Glob√°lis seg√©df√ºggv√©ny manu√°lis haszn√°latra
    window.fixRecipeImage = function(imgElement, category) {
        if (category) {
            imgElement.setAttribute('data-category', category);
        }
        handleImageError(imgElement);
    };
    
    // Debug funkci√≥
    window.debugImages = function() {
        const images = document.querySelectorAll('img');
        console.log('üêõ K√©pek debug info:');
        images.forEach((img, index) => {
            console.log(`${index + 1}. ${img.src} - Protected: ${img.hasAttribute('data-protected')} - Fallback: ${img.hasAttribute('data-fallback-applied')}`);
        });
    };
    </script>
</body>
</html>
