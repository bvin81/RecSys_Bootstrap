{% extends "base.html" %}

{% block title %}üîç Keres√©si eredm√©nyek: "{{ query }}" - GreenRec{% endblock %}

{% block content %}
<div class="container">
    <!-- Fejl√©c -->
    <div class="header-section">
        <h1 class="page-title">
            üîç Keres√©si Eredm√©nyek
        </h1>
        <p class="page-subtitle">
            Tal√°latok: <strong>"{{ query }}"</strong>
        </p>
    </div>

    <!-- Keres√©si statisztik√°k -->
    <div class="search-stats">
        <div class="stats-container">
            <div class="stat-item">
                <span class="stat-number">{{ results_count }}</span>
                <span class="stat-label">Tal√°lat</span>
            </div>
            <div class="stat-item">
                <span class="stat-icon">üîç</span>
                <span class="stat-text">{{ query }}</span>
            </div>
            <div class="stat-actions">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Vissza az aj√°nl√°sokhoz
                </a>
            </div>
        </div>
    </div>

    <!-- √öj keres√©s -->
    <div class="search-section">
        <h3 class="search-title">
            <i class="fas fa-search"></i> √öj keres√©s
        </h3>
        <div class="search-container">
            <input type="text" 
                   id="searchInput" 
                   class="search-input" 
                   value="{{ query }}"
                   placeholder="pl. csirke, rizs, paradicsom..."
                   onkeypress="handleSearchKeypress(event)">
            <button onclick="performSearch()" class="btn btn-search">
                <i class="fas fa-search"></i> Keres√©s
            </button>
        </div>
    </div>

    <!-- Keres√©si eredm√©nyek -->
    {% if recipes and results_count > 0 %}
    <div class="results-section">
        <h2 class="section-title">
            üçΩÔ∏è Tal√°latok ({{ results_count }} db)
        </h2>
        
        <!-- Rendez√©si opci√≥k -->
        <div class="sort-options">
            <label>Rendez√©s:</label>
            <select id="sortSelect" onchange="sortResults(this.value)" class="sort-select">
                <option value="relevance">Relevancia szerint</option>
                <option value="composite_score">√ñsszpontsz√°m szerint</option>
                <option value="name">N√©v szerint</option>
                {% if not hide_scores %}
                <option value="esi_inverted">K√∂rnyezeti hat√°s szerint</option>
                <option value="health_score">Eg√©szs√©g√ºgyi √©rt√©k szerint</option>
                <option value="popularity">N√©pszer≈±s√©g szerint</option>
                {% endif %}
            </select>
        </div>
        
        <div class="recipe-grid" id="searchResults">
            {% for recipe in recipes %}
            <div class="recipe-card search-result" 
                 data-recipe-id="{{ recipe.recipe_id or loop.index }}"
                 data-relevance="{{ recipe.relevance_score or 0 }}"
                 data-composite="{{ recipe.composite_score or 60 }}"
                 data-name="{{ recipe.name or 'Recept' }}">
                
                <!-- Relevancia score -->
                <div class="relevance-badge">
                    <span class="relevance-score">
                        {{ ((recipe.relevance_score or 0) * 100) | round(0) }}% relevancia
                    </span>
                </div>
                
                <!-- Recept k√©p -->
                <div class="recipe-image-container">
                    <img src="{{ recipe.image_url or url_for('static', filename='images/placeholder.jpg') }}" 
                         alt="{{ recipe.name or 'Recept' }}" 
                         class="recipe-image"
                         onerror="this.src='{{ url_for('static', filename='images/placeholder.jpg') }}'">
                </div>
                
                <div class="recipe-content">
                    <!-- Recept neve -->
                    <h3 class="recipe-title">
                        {{ recipe.name or ('Recept #' + loop.index|string) }}
                    </h3>
                    
                    <!-- √ñsszetev≈ëk preview (kiemelve a keresett kifejez√©sek) -->
                    {% if recipe.ingredients %}
                    <p class="recipe-ingredients">
                        <i class="fas fa-list"></i>
                        {{ recipe.ingredients | highlight_search(query) | safe }}
                    </p>
                    {% endif %}
                    
                    <!-- Kateg√≥ria √©s egy√©b info -->
                    <div class="recipe-info">
                        {% if recipe.category %}
                        <span class="recipe-category">
                            <i class="fas fa-tag"></i>
                            {{ recipe.category }}
                        </span>
                        {% endif %}
                        
                        {% if recipe.preparation_time %}
                        <span class="recipe-time">
                            <i class="fas fa-clock"></i>
                            {{ recipe.preparation_time }} perc
                        </span>
                        {% endif %}
                        
                        {% if recipe.difficulty %}
                        <span class="recipe-difficulty">
                            <i class="fas fa-signal"></i>
                            {{ recipe.difficulty }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Metrik√°k (B √©s C csoportnak) -->
                    {% if not hide_scores %}
                    <div class="recipe-metrics">
                        <div class="metric">
                            <span class="metric-icon">üåç</span>
                            <div class="metric-value">{{ (recipe.esi_inverted or 50) | round_float(1) }}</div>
                            <div class="metric-label">K√∂rnyezeti</div>
                        </div>
                        <div class="metric">
                            <span class="metric-icon">üíö</span>
                            <div class="metric-value">{{ (recipe.health_score or 60) | round_float(1) }}</div>
                            <div class="metric-label">Eg√©szs√©g√ºgyi</div>
                        </div>
                        <div class="metric">
                            <span class="metric-icon">üë§</span>
                            <div class="metric-value">{{ (recipe.popularity or 70) | round_float(1) }}</div>
                            <div class="metric-label">N√©pszer≈±s√©g</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Kompozit pontsz√°m -->
                    <div class="composite-score">
                        <span class="score-label">√ñsszpontsz√°m:</span>
                        <span class="score-value">{{ (recipe.composite_score or 60) | round_float(1) }}/100</span>
                    </div>
                    
                    <!-- Akci√≥ gombok -->
                    <div class="recipe-actions">
                        <button onclick="addToFavorites({{ recipe.recipe_id or loop.index }})" 
                                class="btn btn-sm btn-outline">
                            <i class="fas fa-heart"></i> Kedvenc
                        </button>
                        <button onclick="viewRecipeDetails({{ recipe.recipe_id or loop.index }})" 
                                class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> R√©szletek
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Tov√°bbi keres√©si javaslatok -->
    <div class="search-suggestions">
        <h3>üí° Pr√≥b√°lja ki ezeket is:</h3>
        <div class="suggestion-tags">
            <button onclick="searchFor('csirkemell z√∂lds√©gek')" class="tag-btn">csirkemell z√∂lds√©gek</button>
            <button onclick="searchFor('eg√©szs√©ges sal√°ta')" class="tag-btn">eg√©szs√©ges sal√°ta</button>
            <button onclick="searchFor('veget√°ri√°nus')" class="tag-btn">veget√°ri√°nus</button>
            <button onclick="searchFor('gyors vacsora')" class="tag-btn">gyors vacsora</button>
            <button onclick="searchFor('alacsony kal√≥ria')" class="tag-btn">alacsony kal√≥ria</button>
            <button onclick="searchFor('mediterr√°n')" class="tag-btn">mediterr√°n</button>
        </div>
    </div>
    
    {% else %}
    <!-- Nincs tal√°lat -->
    <div class="no-results">
        <div class="no-results-content">
            <i class="fas fa-search fa-4x"></i>
            <h3>Nincs tal√°lat</h3>
            <p>A <strong>"{{ query }}"</strong> keres√©sre nem tal√°ltunk recepteket.</p>
            
            <div class="no-results-suggestions">
                <h4>üí° Pr√≥b√°lja meg:</h4>
                <ul>
                    <li>R√∂videbb vagy √°ltal√°nosabb kifejez√©sek haszn√°lat√°t</li>
                    <li>Ellen≈ërizze a helyes√≠r√°st</li>
                    <li>Pr√≥b√°ljon m√°s √∂sszetev≈ëket keresni</li>
                    <li>B√∂ng√©ssze az aj√°nlott recepteket</li>
                </ul>
                
                <div class="suggestion-actions">
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-home"></i> Aj√°nlott receptek
                    </a>
                    <button onclick="clearSearch()" class="btn btn-secondary">
                        <i class="fas fa-eraser"></i> √öj keres√©s
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Hidden data -->
<input type="hidden" id="currentQuery" value="{{ query }}">
<input type="hidden" id="userGroup" value="{{ user_group }}">
<input type="hidden" id="hideScores" value="{{ hide_scores }}">
{% endblock %}

{% block extra_scripts %}
<script>
// Keres√©si eredm√©nyek rendez√©se
function sortResults(sortBy) {
    const resultsContainer = document.getElementById('searchResults');
    const cards = Array.from(resultsContainer.querySelectorAll('.search-result'));
    
    cards.sort((a, b) => {
        let aVal, bVal;
        
        switch(sortBy) {
            case 'relevance':
                aVal = parseFloat(a.dataset.relevance) || 0;
                bVal = parseFloat(b.dataset.relevance) || 0;
                return bVal - aVal; // Cs√∂kken≈ë sorrend
                
            case 'composite_score':
                aVal = parseFloat(a.dataset.composite) || 0;
                bVal = parseFloat(b.dataset.composite) || 0;
                return bVal - aVal; // Cs√∂kken≈ë sorrend
                
            case 'name':
                aVal = a.dataset.name.toLowerCase();
                bVal = b.dataset.name.toLowerCase();
                return aVal.localeCompare(bVal); // N√∂vekv≈ë sorrend
                
            case 'esi_inverted':
                aVal = parseFloat(a.querySelector('.metric:nth-child(1) .metric-value')?.textContent) || 0;
                bVal = parseFloat(b.querySelector('.metric:nth-child(1) .metric-value')?.textContent) || 0;
                return bVal - aVal;
                
            case 'health_score':
                aVal = parseFloat(a.querySelector('.metric:nth-child(2) .metric-value')?.textContent) || 0;
                bVal = parseFloat(b.querySelector('.metric:nth-child(2) .metric-value')?.textContent) || 0;
                return bVal - aVal;
                
            case 'popularity':
                aVal = parseFloat(a.querySelector('.metric:nth-child(3) .metric-value')?.textContent) || 0;
                bVal = parseFloat(b.querySelector('.metric:nth-child(3) .metric-value')?.textContent) || 0;
                return bVal - aVal;
                
            default:
                return 0;
        }
    });
    
    // DOM-ba visszahelyez√©s
    cards.forEach(card => resultsContainer.appendChild(card));
    
    // Toast √ºzenet
    showToast(`Eredm√©nyek rendezve: ${getSortDisplayName(sortBy)}`, 'info');
}

function getSortDisplayName(sortBy) {
    const names = {
        'relevance': 'Relevancia szerint',
        'composite_score': '√ñsszpontsz√°m szerint', 
        'name': 'N√©v szerint',
        'esi_inverted': 'K√∂rnyezeti hat√°s szerint',
        'health_score': 'Eg√©szs√©g√ºgyi √©rt√©k szerint',
        'popularity': 'N√©pszer≈±s√©g szerint'
    };
    return names[sortBy] || sortBy;
}

// Javaslat keres√©sek
function searchFor(query) {
    document.getElementById('searchInput').value = query;
    performSearch();
}

// Keres√©s t√∂rl√©se
function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchInput').focus();
}

// Kedvencekhez ad√°s (placeholder)
function addToFavorites(recipeId) {
    showToast('Kedvencekhez adva! ‚ù§Ô∏è', 'success');
    // Itt lehetne localStorage vagy szerver k√©r√©s
}

// Recept r√©szletek (placeholder)  
function viewRecipeDetails(recipeId) {
    showToast('Recept r√©szletek (fejleszt√©s alatt)', 'info');
    // Itt lehetne modal vagy √∫j oldal
}

// Oldal bet√∂lt√©skor
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus a keres≈ëmez≈ëre
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.focus();
        searchInput.select();
    }
    
    // Eredm√©nyek anim√°l√°sa
    const results = document.querySelectorAll('.search-result');
    results.forEach((result, index) => {
        setTimeout(() => {
            result.style.animation = 'fadeInUp 0.5s ease forwards';
        }, index * 100);
    });
});
</script>

<style>
/* Keres√©si eredm√©nyek specifikus st√≠lusok */
.search-stats {
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-md);
}

.stats-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing-lg);
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
}

.stat-number {
    font-size: var(--font-size-2xl);
    font-weight: bold;
    color: var(--primary-color);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--dark-gray);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.stat-text {
    font-style: italic;
    color: var(--dark-gray);
}

.sort-options {
    background: rgba(255, 255, 255, 0.9);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-xl);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.sort-select {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 2px solid var(--gray);
    border-radius: var(--radius-md);
    background: var(--white);
    font-size: var(--font-size-base);
}

.relevance-badge {
    position: absolute;
    top: var(--spacing-md);
    left: var(--spacing-md);
    background: var(--info-color);
    color: var(--white);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: bold;
    z-index: 10;
}

.recipe-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin: var(--spacing-md) 0;
    font-size: var(--font-size-sm);
}

.recipe-category,
.recipe-time, 
.recipe-difficulty {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--dark-gray);
    background: var(--light-gray);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
}

.recipe-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
}

.btn-sm {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-sm);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: var(--white);
}

.search-suggestions {
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    margin-top: var(--spacing-xl);
    text-align: center;
}

.suggestion-tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-lg);
}

.tag-btn {
    background: var(--light-gray);
    border: none;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-xl);
    cursor: pointer;
    transition: var(--transition-fast);
    font-size: var(--font-size-sm);
}

.tag-btn:hover {
    background: var(--primary-color);
    color: var(--white);
    transform: translateY(-2px);
}

.no-results {
    text-align: center;
    padding: var(--spacing-2xl);
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--radius-xl);
    margin: var(--spacing-xl) 0;
}

.no-results-content i {
    color: var(--gray);
    margin-bottom: var(--spacing-lg);
}

.no-results-suggestions {
    margin-top: var(--spacing-xl);
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.no-results-suggestions ul {
    margin: var(--spacing-lg) 0;
    padding-left: var(--spacing-xl);
}

.no-results-suggestions li {
    margin-bottom: var(--spacing-sm);
    color: var(--dark-gray);
}

.suggestion-actions {
    display: flex;
    justify-content: center;
    gap: var(--spacing-lg);
    margin-top: var(--spacing-xl);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .stats-container {
        flex-direction: column;
        text-align: center;
    }
    
    .sort-options {
        flex-direction: column;
        align-items: stretch;
    }
    
    .suggestion-actions {
        flex-direction: column;
        align-items: center;
    }
}
</style>
{% endblock %}
