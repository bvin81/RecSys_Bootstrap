{% extends "base.html" %}

{% block title %}üèÜ Az √ñn Eredm√©nyei - GreenRec{% endblock %}

{% block content %}
<div class="container">
    <!-- Fejl√©c -->
    <div class="header-section">
        <h1 class="page-title">
            üèÜ Az √ñn Eredm√©nyei
        </h1>
        <p class="page-subtitle">
            {{ get_group_name(user_summary.user_group) }} Csoport - Tanulm√°ny √ñsszefoglal√≥ja
        </p>
    </div>

    <!-- √ñsszefoglal√≥ k√°rty√°k -->
    <div class="summary-cards">
        <div class="summary-card completion">
            <div class="card-icon">
                {% if user_summary.study_completed %}
                <i class="fas fa-check-circle"></i>
                {% else %}
                <i class="fas fa-clock"></i>
                {% endif %}
            </div>
            <div class="card-content">
                <h3>Tanulm√°ny √Ållapota</h3>
                <p class="card-value">
                    {% if user_summary.study_completed %}
                    Befejezve ‚úÖ
                    {% else %}
                    Folyamatban ‚è≥
                    {% endif %}
                </p>
                <p class="card-detail">
                    {{ user_summary.current_round or 1 }}/{{ total_rounds }} k√∂r teljes√≠tve
                </p>
            </div>
        </div>

        <div class="summary-card ratings">
            <div class="card-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="card-content">
                <h3>√ñsszes √ârt√©kel√©s</h3>
                <p class="card-value">{{ user_summary.total_ratings or 0 }}</p>
                <p class="card-detail">
                    √Åtlag: {{ ((user_metrics.satisfaction or 0) * 5) | round_float(1) }}/5 ‚≠ê
                </p>
            </div>
        </div>

        <div class="summary-card performance">
            <div class="card-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="card-content">
                <h3>F1 Score</h3>
                <p class="card-value">{{ (user_metrics.f1_score or 0) | percentage }}</p>
                <p class="card-detail">
                    Aj√°nl√°si rendszer teljes√≠tm√©ny
                </p>
            </div>
        </div>

        <div class="summary-card time">
            <div class="card-icon">
                <i class="fas fa-stopwatch"></i>
            </div>
            <div class="card-content">
                <h3>Id≈ëtartam</h3>
                <p class="card-value">
                    {{ (user_summary.session_duration_minutes or 0) | round(0) }} perc
                </p>
                <p class="card-detail">
                    Akt√≠v r√©szv√©teli id≈ë
                </p>
            </div>
        </div>
    </div>

    <!-- R√©szletes metrik√°k -->
    <div class="detailed-metrics">
        <h2 class="section-title">
            üìä R√©szletes Teljes√≠tm√©ny Metrik√°k
        </h2>

        <div class="metrics-grid">
            <!-- Precision@5 -->
            <div class="metric-card">
                <div class="metric-header">
                    <h4>üéØ Precision@5</h4>
                    <span class="metric-help" title="Relev√°ns aj√°nl√°sok ar√°nya a top 5-ben">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </div>
                <div class="metric-visual">
                    <div class="progress-circle" data-percentage="{{ (user_metrics.precision_at_5 or 0) * 100 }}">
                        <span class="progress-text">{{ (user_metrics.precision_at_5 or 0) | percentage }}</span>
                    </div>
                </div>
                <p class="metric-description">
                    A top 5 aj√°nl√°sb√≥l h√°nyat √©rt√©kelt magasra (4-5 ‚≠ê)
                </p>
            </div>

            <!-- Recall@5 -->
            <div class="metric-card">
                <div class="metric-header">
                    <h4>üîÑ Recall@5</h4>
                    <span class="metric-help" title="Mennyire tal√°lta meg az √∂sszes relev√°ns receptet">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </div>
                <div class="metric-visual">
                    <div class="progress-circle" data-percentage="{{ (user_metrics.recall_at_5 or 0) * 100 }}">
                        <span class="progress-text">{{ (user_metrics.recall_at_5 or 0) | percentage }}</span>
                    </div>
                </div>
                <p class="metric-description">
                    Az √∂sszes kedvelt receptb≈ël mennyit tal√°lt meg a rendszer
                </p>
            </div>

            <!-- Diversity -->
            <div class="metric-card">
                <div class="metric-header">
                    <h4>üåà Diverzit√°s</h4>
                    <span class="metric-help" title="Aj√°nl√°sok v√°ltozatoss√°ga">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </div>
                <div class="metric-visual">
                    <div class="progress-circle" data-percentage="{{ (user_metrics.diversity_score or 0) * 100 }}">
                        <span class="progress-text">{{ (user_metrics.diversity_score or 0) | percentage }}</span>
                    </div>
                </div>
                <p class="metric-description">
                    Mennyire v√°ltozatosak voltak az aj√°nlott receptek
                </p>
            </div>

            <!-- Novelty -->
            <div class="metric-card">
                <div class="metric-header">
                    <h4>‚ú® √öjdons√°g</h4>
                    <span class="metric-help" title="Mennyire szokatlan recepteket tal√°lt">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </div>
                <div class="metric-visual">
                    <div class="progress-circle" data-percentage="{{ (user_metrics.novelty_score or 0) * 100 }}">
                        <span class="progress-text">{{ (user_metrics.novelty_score or 0) | percentage }}</span>
                    </div>
                </div>
                <p class="metric-description">
                    Mennyire √∫jszer≈± vagy kev√©sb√© ismert recepteket fedezett fel
                </p>
            </div>
        </div>
    </div>

    <!-- K√∂r√∂nk√©nti r√©szletez√©s -->
    <div class="round-breakdown">
        <h2 class="section-title">
            üîÑ K√∂r√∂nk√©nti Teljes√≠tm√©ny
        </h2>

        <div class="rounds-container">
            {% for round_num in range(1, total_rounds + 1) %}
            <div class="round-card {% if round_num <= (user_summary.current_round or 1) %}completed{% else %}pending{% endif %}">
                <div class="round-header">
                    <span class="round-number">{{ round_num }}</span>
                    <h4>{{ round_num }}. K√∂r</h4>
                    {% if round_num <= (user_summary.current_round or 1) %}
                    <span class="round-status completed">
                        <i class="fas fa-check"></i>
                    </span>
                    {% else %}
                    <span class="round-status pending">
                        <i class="fas fa-clock"></i>
                    </span>
                    {% endif %}
                </div>
                
                <div class="round-stats">
                    {% set round_ratings = user_summary.ratings_by_round.get('round_' + round_num|string, 0) %}
                    <div class="stat">
                        <span class="stat-label">√ârt√©kel√©sek:</span>
                        <span class="stat-value">{{ round_ratings }}</span>
                    </div>
                    
                    {% if round_num <= (user_summary.current_round or 1) and round_ratings > 0 %}
                    <div class="stat">
                        <span class="stat-label">√Ållapot:</span>
                        <span class="stat-value success">Teljes√≠tve</span>
                    </div>
                    {% elif round_num == (user_summary.current_round or 1) %}
                    <div class="stat">
                        <span class="stat-label">√Ållapot:</span>
                        <span class="stat-value current">Akt√≠v</span>
                    </div>
                    {% else %}
                    <div class="stat">
                        <span class="stat-label">√Ållapot:</span>
                        <span class="stat-value pending">V√°rakozik</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- √ârt√©kel√©si szok√°sok -->
    <div class="rating-patterns">
        <h2 class="section-title">
            ‚≠ê √ârt√©kel√©si Szok√°sok
        </h2>

        <div class="patterns-container">
            <!-- √ârt√©kel√©sek eloszl√°sa -->
            <div class="pattern-card">
                <h4>√ârt√©kel√©sek Eloszl√°sa</h4>
                <div class="rating-distribution">
                    {% for rating in range(1, 6) %}
                    {% set count = user_summary.rating_distribution.get(rating, 0) %}
                    {% set percentage = (count / (user_summary.total_ratings or 1) * 100) if user_summary.total_ratings > 0 else 0 %}
                    <div class="rating-bar">
                        <span class="rating-label">{{ rating }} ‚≠ê</span>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: {{ percentage }}%"></div>
                        </div>
                        <span class="rating-count">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Preferenci√°k elemz√©se -->
            <div class="pattern-card">
                <h4>Preferencia Elemz√©s</h4>
                <div class="preferences">
                    <div class="preference-item">
                        <span class="pref-icon">üåç</span>
                        <div class="pref-content">
                            <span class="pref-label">K√∂rnyezettudatoss√°g</span>
                            <div class="pref-bar">
                                <div class="pref-fill" style="width: {{ ((user_metrics.satisfaction or 0) * 100) }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="preference-item">
                        <span class="pref-icon">üíö</span>
                        <div class="pref-content">
                            <span class="pref-label">Eg√©szs√©gtudatoss√°g</span>
                            <div class="pref-bar">
                                <div class="pref-fill" style="width: {{ ((user_metrics.satisfaction or 0) * 90) }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="preference-item">
                        <span class="pref-icon">üë§</span>
                        <div class="pref-content">
                            <span class="pref-label">N√©pszer≈± receptek</span>
                            <div class="pref-bar">
                                <div class="pref-fill" style="width: {{ ((user_metrics.satisfaction or 0) * 80) }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √ñsszehasonl√≠t√°s m√°s csoportokkal -->
    <div class="group-comparison">
        <h2 class="section-title">
            üî¨ √ñsszehasonl√≠t√°s M√°s Csoportokkal
        </h2>

        <div class="comparison-note">
            <p>
                <i class="fas fa-info-circle"></i>
                Az √ñn teljes√≠tm√©nye ({{ get_group_name(user_summary.user_group) }} csoport) 
                √∂sszehasonl√≠tva a t√∂bbi tesztel≈ë csoporttal:
            </p>
        </div>

        <div class="comparison-chart">
            <div class="chart-container">
                <canvas id="comparisonChart" width="400" height="200"></canvas>
            </div>
            
            <div class="comparison-legend">
                <div class="legend-item group-a">
                    <span class="legend-color"></span>
                    <span>A Csoport (Alap√©rtelmezett)</span>
                </div>
                <div class="legend-item group-b">
                    <span class="legend-color"></span>
                    <span>B Csoport (Score-t√°mogatott)</span>
                </div>
                <div class="legend-item group-c">
                    <span class="legend-color"></span>
                    <span>C Csoport (Intelligens hibrid)</span>
                </div>
                <div class="legend-item current-user">
                    <span class="legend-color"></span>
                    <span>Az √ñn teljes√≠tm√©nye</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Szem√©lyes aj√°nl√°sok -->
    <div class="personal-recommendations">
        <h2 class="section-title">
            üí° Szem√©lyes Fejleszt√©si Javaslatok
        </h2>

        <div class="recommendations-grid">
            {% if (user_metrics.precision_at_5 or 0) < 0.6 %}
            <div class="recommendation-card">
                <div class="rec-icon">üéØ</div>
                <h4>Pontoss√°g Fejleszt√©se</h4>
                <p>Pr√≥b√°ljon t√∂bb id≈ët sz√°nni az aj√°nl√°sok alapos √°tgondol√°s√°ra. 
                   A {{ ((1 - (user_metrics.precision_at_5 or 0)) * 100) | round(0) }}%-os jav√≠t√°si potenci√°l jelent≈ës!</p>
            </div>
            {% endif %}

            {% if (user_metrics.diversity_score or 0) < 0.5 %}
            <div class="recommendation-card">
                <div class="rec-icon">üåà</div>
                <h4>V√°ltozatoss√°g N√∂vel√©se</h4>
                <p>√ârdemes kipr√≥b√°lni √∫j kateg√≥ri√°j√∫ recepteket √©s √∂sszetev≈ëket. 
                   Ez gazdag√≠thatja a kulin√°ris √©lm√©nyeit!</p>
            </div>
            {% endif %}

            {% if user_summary.total_ratings < 10 %}
            <div class="recommendation-card">
                <div class="rec-icon">‚≠ê</div>
                <h4>T√∂bb √ârt√©kel√©s</h4>
                <p>Tov√°bbi √©rt√©kel√©sekkel m√©g pontosabb aj√°nl√°sokat kaphat. 
                   Folytassa a tanulm√°nyt a jobb eredm√©nyek√©rt!</p>
            </div>
            {% endif %}

            {% if (user_metrics.satisfaction or 0) > 0.8 %}
            <div class="recommendation-card success">
                <div class="rec-icon">üèÜ</div>
                <h4>Kiv√°l√≥ Teljes√≠tm√©ny!</h4>
                <p>Gratul√°lunk! Az √ñn el√©gedetts√©ge kimagasl√≥. 
                   Folytathatja az eg√©szs√©gtudatos receptek felfedez√©s√©t!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Akci√≥ gombok -->
    <div class="action-buttons">
        {% if not user_summary.study_completed %}
        <a href="{{ url_for('index') }}" class="btn btn-primary btn-large">
            <i class="fas fa-play"></i>
            Tanulm√°ny Folytat√°sa
        </a>
        {% endif %}
        
        <a href="{{ url_for('analytics') }}" class="btn btn-secondary btn-large">
            <i class="fas fa-chart-bar"></i>
            R√©szletes Analytics
        </a>
        
        <button onclick="exportResults()" class="btn btn-outline btn-large">
            <i class="fas fa-download"></i>
            Eredm√©nyek Let√∂lt√©se
        </button>
        
        <a href="{{ url_for('reset_session') }}" class="btn btn-warning btn-large">
            <i class="fas fa-refresh"></i>
            √öj Pr√≥b√°lkoz√°s
        </a>
    </div>

    <!-- K√∂sz√∂netnyilv√°n√≠t√°s -->
    <div class="thank-you">
        <div class="thank-you-content">
            <h3>üôè K√∂sz√∂nj√ºk a R√©szv√©telt!</h3>
            <p>
                Az √ñn √©rt√©kes visszajelz√©sei hozz√°j√°rulnak a fenntarthat√≥ 
                √©tkez√©si szok√°sok kutat√°s√°hoz √©s az aj√°nl√≥rendszerek fejleszt√©s√©hez.
            </p>
            {% if user_summary.study_completed %}
            <p class="completion-message">
                <strong>A tanulm√°ny sikeresen befejez≈ëd√∂tt!</strong> 
                Eredm√©nyei seg√≠tik az AI-alap√∫ receptaj√°nl√≥k tov√°bbfejleszt√©s√©t.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Hidden data for charts -->
<script type="text/javascript">
    window.userResults = {
        user_group: '{{ user_summary.user_group }}',
        metrics: {{ user_metrics | tojson }},
        summary: {{ user_summary | tojson }}
    };
</script>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// Progress circles anim√°l√°sa
function animateProgressCircles() {
    const circles = document.querySelectorAll('.progress-circle');
    
    circles.forEach(circle => {
        const percentage = parseFloat(circle.dataset.percentage) || 0;
        const circumference = 2 * Math.PI * 45; // 45px radius
        const strokeDasharray = circumference;
        const strokeDashoffset = circumference - (percentage / 100) * circumference;
        
        // SVG l√©trehoz√°sa ha nincs m√©g
        if (!circle.querySelector('svg')) {
            circle.innerHTML = `
                <svg width="120" height="120" viewBox="0 0 120 120">
                    <circle cx="60" cy="60" r="45" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                    <circle cx="60" cy="60" r="45" fill="none" stroke="#4CAF50" stroke-width="8"
                            stroke-dasharray="${strokeDasharray}" 
                            stroke-dashoffset="${strokeDasharray}"
                            stroke-linecap="round" 
                            transform="rotate(-90 60 60)"
                            class="progress-stroke"/>
                </svg>
                <span class="progress-text">${percentage.toFixed(1)}%</span>
            `;
        }
        
        // Anim√°ci√≥
        setTimeout(() => {
            const stroke = circle.querySelector('.progress-stroke');
            if (stroke) {
                stroke.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
                stroke.style.strokeDashoffset = strokeDashoffset;
            }
        }, 500);
    });
}

// √ñsszehasonl√≠t√°si chart
function createComparisonChart() {
    const ctx = document.getElementById('comparisonChart');
    if (!ctx || !window.Chart) return;
    
    // Demo adatok (val√≥s implement√°ci√≥ban az analytics service-b≈ël j√∂nne)
    const currentUserMetrics = window.userResults.metrics;
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Precision@5', 'Recall@5', 'F1 Score', 'Diverzit√°s', 'El√©gedetts√©g'],
            datasets: [
                {
                    label: 'A Csoport',
                    data: [0.42, 0.38, 0.40, 0.45, 0.52],
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    pointBackgroundColor: '#1976d2'
                },
                {
                    label: 'B Csoport', 
                    data: [0.58, 0.54, 0.56, 0.52, 0.68],
                    borderColor: '#388e3c',
                    backgroundColor: 'rgba(56, 142, 60, 0.1)',
                    pointBackgroundColor: '#388e3c'
                },
                {
                    label: 'C Csoport',
                    data: [0.74, 0.71, 0.72, 0.68, 0.82],
                    borderColor: '#f57c00',
                    backgroundColor: 'rgba(245, 124, 0, 0.1)',
                    pointBackgroundColor: '#f57c00'
                },
                {
                    label: 'Az √ñn teljes√≠tm√©nye',
                    data: [
                        currentUserMetrics.precision_at_5 || 0,
                        currentUserMetrics.recall_at_5 || 0,
                        currentUserMetrics.f1_score || 0,
                        currentUserMetrics.diversity_score || 0,
                        currentUserMetrics.satisfaction || 0
                    ],
                    borderColor: '#e91e63',
                    backgroundColor: 'rgba(233, 30, 99, 0.2)',
                    pointBackgroundColor: '#e91e63',
                    borderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false // K√ºl√∂n legend van
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 1,
                    ticks: {
                        stepSize: 0.2
                    }
                }
            }
        }
    });
}

// Eredm√©nyek export√°l√°sa
function exportResults() {
    const results = {
        user_info: window.userResults.summary,
        metrics: window.userResults.metrics,
        export_date: new Date().toISOString(),
        study_type: 'GreenRec A/B/C Test'
    };
    
    const dataStr = JSON.stringify(results, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `greenrec_results_${window.userResults.user_group}_${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showToast('Eredm√©nyek export√°lva! üìä', 'success');
}

// Oldal bet√∂lt√©se
document.addEventListener('DOMContentLoaded', function() {
    // Progress circles anim√°l√°sa
    setTimeout(() => {
        animateProgressCircles();
    }, 500);
    
    // Chart l√©trehoz√°sa
    setTimeout(() => {
        createComparisonChart();
    }, 1000);
    
    // K√°rty√°k anim√°l√°sa
    const cards = document.querySelectorAll('.summary-card, .metric-card, .round-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.animation = 'fadeInUp 0.5s ease forwards';
        }, index * 100);
    });
});
</script>
{% endblock %}
