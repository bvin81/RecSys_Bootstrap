{% extends "base.html" %}

{% block title %}üå± GreenRec - {{ current_round }}. k√∂r{% endblock %}

{% block content %}
<div class="container">
    <!-- Fejl√©c √©s progress -->
    <div class="header-section">
        <h1 class="page-title">
            üå± Fenntarthat√≥ Receptaj√°nl√≥
        </h1>
        <p class="page-subtitle">
            Fedezze fel az eg√©szs√©ges √©s k√∂rnyezetbar√°t recepteket!
        </p>
        
        <!-- Progress √©s csoport info -->
        <div class="progress-section">
            <div class="group-info">
                <span class="group-badge group-{{ user_group }}">
                    {{ get_group_name(user_group) }} Csoport
                </span>
                <span class="round-info">
                    {{ current_round }}. k√∂r / {{ max_rounds }}
                </span>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ ((current_round-1) / max_rounds * 100) }}%"></div>
                </div>
                <div class="progress-text">
                    <span>√ârt√©kelve: <strong>{{ rated_count }}</strong> recept</span>
                    <span>Sz√ºks√©ges: <strong>{{ required_ratings }}</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Keres≈ëmez≈ë (ha enged√©lyezett) -->
    {% if enable_search %}
    <div class="search-section">
        <h3 class="search-title">
            <i class="fas fa-search"></i> Keres√©s √∂sszetev≈ëk alapj√°n
        </h3>
        <div class="search-container">
            <input type="text" 
                   id="searchInput" 
                   class="search-input" 
                   placeholder="pl. csirke, rizs, paradicsom..."
                   onkeypress="handleSearchKeypress(event)">
            <button onclick="performSearch()" class="btn btn-search">
                <i class="fas fa-search"></i> Keres√©s
            </button>
        </div>
        <p class="search-hint">
            üí° <strong>Tipp:</strong> A keres√©s nem befoly√°solja a tanulm√°ny eredm√©nyeit
        </p>
    </div>
    {% endif %}

    <!-- Metrik√°k magyar√°zata (csak B √©s C csoportnak) -->
    {% if not hide_scores %}
    <div class="metrics-explanation">
        <h3>üìä √ârt√©kel√©si Szempontok</h3>
        <div class="metrics-grid">
            <div class="metric-info">
                <span class="metric-icon">üåç</span>
                <div>
                    <strong>K√∂rnyezeti Hat√°s</strong>
                    <small>Alacsonyabb CO2 kibocs√°t√°s √©s v√≠zhaszn√°lat</small>
                </div>
            </div>
            <div class="metric-info">
                <span class="metric-icon">üíö</span>
                <div>
                    <strong>Eg√©szs√©g√ºgyi √ârt√©k</strong>
                    <small>T√°panyagok, vitaminok, alacsony kal√≥ria</small>
                </div>
            </div>
            <div class="metric-info">
                <span class="metric-icon">üë§</span>
                <div>
                    <strong>N√©pszer≈±s√©g</strong>
                    <small>Felhaszn√°l√≥i √©rt√©kel√©sek alapj√°n</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Receptaj√°nl√°sok -->
    <div class="recommendations-section">
        <h2 class="section-title">
            üçΩÔ∏è Aj√°nlott Receptek - {{ current_round }}. k√∂r
        </h2>
        
        <div class="recipe-grid" id="recipeGrid">
            {% for recipe in recipes %}
            <div class="recipe-card" 
                 data-recipe-id="{{ recipe.recipe_id or loop.index }}"
                 onclick="selectRecipe(this)">
                
                <!-- Recept k√©p -->
                {% if show_images and recipe.image_url %}
                <div class="recipe-image-container">
                    <img src="{{ recipe.image_url }}" 
                         alt="{{ recipe.name or 'Recept' }}" 
                         class="recipe-image"
                         onerror="this.src='{{ url_for('static', filename='images/placeholder.jpg') }}'">
                </div>
                {% endif %}
                
                <div class="recipe-content">
                    <!-- Recept neve -->
                    <h3 class="recipe-title">
                        {{ recipe.name or ('Recept #' + loop.index|string) }}
                    </h3>
                    
                    <!-- √ñsszetev≈ëk preview -->
                    {% if recipe.ingredients %}
                    <p class="recipe-ingredients">
                        <i class="fas fa-list"></i>
                        {{ recipe.ingredients[:50] }}{% if recipe.ingredients|length > 50 %}...{% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- Metrik√°k (B √©s C csoportnak) -->
                    {% if not hide_scores %}
                    <div class="recipe-metrics">
                        <div class="metric">
                            <span class="metric-icon">üåç</span>
                            <div class="metric-value">{{ (recipe.esi_inverted or 50) | round_float(1) }}</div>
                            <div class="metric-label">K√∂rnyezeti</div>
                        </div>
                        <div class="metric">
                            <span class="metric-icon">üíö</span>
                            <div class="metric-value">{{ (recipe.health_score or 60) | round_float(1) }}</div>
                            <div class="metric-label">Eg√©szs√©g√ºgyi</div>
                        </div>
                        <div class="metric">
                            <span class="metric-icon">üë§</span>
                            <div class="metric-value">{{ (recipe.popularity or 70) | round_float(1) }}</div>
                            <div class="metric-label">N√©pszer≈±s√©g</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Kompozit pontsz√°m (mindig l√°that√≥) -->
                    <div class="composite-score">
                        <span class="score-label">√ñsszpontsz√°m:</span>
                        <span class="score-value">{{ (recipe.composite_score or 60) | round_float(1) }}/100</span>
                    </div>
                    
                    <!-- √ârt√©kel≈ë csillagok -->
                    <div class="rating-container">
                        <div class="stars" data-recipe-id="{{ recipe.recipe_id or loop.index }}">
                            {% for i in range(1, 6) %}
                            <span class="star" data-rating="{{ i }}" onclick="rateRecipe(event, {{ recipe.recipe_id or loop.index }}, {{ i }})">
                                ‚òÖ
                            </span>
                            {% endfor %}
                        </div>
                        <p class="rating-hint">Kattintson az √©rt√©kel√©shez (1-5 csillag)</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Ha nincs recept -->
        {% if not recipes %}
        <div class="empty-state">
            <i class="fas fa-utensils fa-3x"></i>
            <h3>Nincsenek el√©rhet≈ë receptek</h3>
            <p>Pr√≥b√°lja √∫jra k√©s≈ëbb vagy forduljon a rendszergazd√°hoz.</p>
        </div>
        {% endif %}
    </div>

    <!-- Kontroll gombok -->
    <div class="controls-section">
        <div class="controls-info">
            <p class="rating-status" id="ratingStatus">
                {{ rated_count }} / {{ required_ratings }} recept √©rt√©kelve
            </p>
            {% if current_round < max_rounds %}
            <p class="next-round-hint">
                Legal√°bb {{ required_ratings }} recept √©rt√©kel√©se sz√ºks√©ges a k√∂vetkez≈ë k√∂rhez
            </p>
            {% else %}
            <p class="completion-hint">
                Utols√≥ k√∂r - tanulm√°ny befejez√©se az √©rt√©kel√©sek ut√°n
            </p>
            {% endif %}
        </div>
        
        <div class="controls-buttons">
            {% if current_round < max_rounds %}
            <button id="nextRoundBtn" 
                    onclick="advanceToNextRound()" 
                    class="btn btn-primary"
                    {% if not can_proceed %}disabled{% endif %}>
                <i class="fas fa-arrow-right"></i>
                {% if can_proceed %}
                    K√∂vetkez≈ë K√∂r
                {% else %}
                    {{ rated_count }}/{{ required_ratings }} √ârt√©kel√©s
                {% endif %}
            </button>
            {% else %}
            <button id="completeStudyBtn" 
                    onclick="completeStudy()" 
                    class="btn btn-success"
                    {% if not can_proceed %}disabled{% endif %}>
                <i class="fas fa-flag-checkered"></i>
                {% if can_proceed %}
                    Tanulm√°ny Befejez√©se
                {% else %}
                    {{ rated_count }}/{{ required_ratings }} √ârt√©kel√©s
                {% endif %}
            </button>
            {% endif %}
            
            <button onclick="showResults()" class="btn btn-secondary">
                <i class="fas fa-chart-line"></i>
                R√©szeredm√©nyek
            </button>
        </div>
    </div>
</div>

<!-- Hidden form data -->
<input type="hidden" id="currentRound" value="{{ current_round }}">
<input type="hidden" id="userGroup" value="{{ user_group }}">
<input type="hidden" id="maxRounds" value="{{ max_rounds }}">
<input type="hidden" id="requiredRatings" value="{{ required_ratings }}">
{% endblock %}

{% block extra_scripts %}
<script>
// Glob√°lis v√°ltoz√≥k
let ratings = {};
let selectedRecipes = new Set();
const currentRound = parseInt(document.getElementById('currentRound').value);
const maxRounds = parseInt(document.getElementById('maxRounds').value);
const requiredRatings = parseInt(document.getElementById('requiredRatings').value);

// Oldal bet√∂lt√©skor inicializ√°l√°s
document.addEventListener('DOMContentLoaded', function() {
    updateUI();
});

// Recept √©rt√©kel√©se
function rateRecipe(event, recipeId, rating) {
    event.stopPropagation();
    
    // √ârt√©kel√©s ment√©se
    ratings[recipeId] = rating;
    
    // Csillagok friss√≠t√©se
    const starsContainer = document.querySelector(`[data-recipe-id="${recipeId}"]`);
    const stars = starsContainer.querySelectorAll('.star');
    
    stars.forEach((star, index) => {
        star.classList.toggle('active', index < rating);
    });
    
    // K√°rtya kijel√∂l√©se
    const card = document.querySelector(`[data-recipe-id="${recipeId}"]`);
    card.classList.add('selected');
    selectedRecipes.add(recipeId);
    
    // UI friss√≠t√©se
    updateUI();
    
    // AJAX k√©r√©s a szerverre
    fetch('/rate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            recipe_id: recipeId,
            rating: rating,
            round_number: currentRound
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('√ârt√©kel√©s mentve! ‚≠ê', 'success');
            updateUI();
        } else {
            showToast('Hiba az √©rt√©kel√©s ment√©se sor√°n', 'error');
        }
    })
    .catch(error => {
        console.error('√ârt√©kel√©si hiba:', error);
        showToast('H√°l√≥zati hiba', 'error');
    });
}

// Tanulm√°ny befejez√©se
function completeStudy() {
    if (Object.keys(ratings).length < requiredRatings) {
        showToast(`Legal√°bb ${requiredRatings} recept √©rt√©kel√©se sz√ºks√©ges!`, 'warning');
        return;
    }
    
    showLoading();
    
    // Ugyanaz mint a k√∂vetkez≈ë k√∂r, de m√°s √ºzenet
    fetch('/next_round', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            showToast('Tanulm√°ny befejezve! Eredm√©nyek bet√∂lt√©se...', 'success');
            setTimeout(() => {
                window.location.href = '/results';
            }, 1000);
        } else {
            showToast('Hiba a tanulm√°ny befejez√©s√©ben', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Tanulm√°ny befejez√©si hiba:', error);
        showToast('H√°l√≥zati hiba', 'error');
    });
}

// Eredm√©nyek megtekint√©se
function showResults() {
    window.location.href = '/results';
}

// Keres√©si funkci√≥k
function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        performSearch();
    }
}

function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    
    if (query.length < 2) {
        showToast('Legal√°bb 2 karakter sz√ºks√©ges a keres√©shez!', 'warning');
        return;
    }
    
    showLoading();
    window.location.href = `/search?q=${encodeURIComponent(query)}`;
}

// Utility funkci√≥k a main.js-b≈ël
function showToast(message, type = 'info') {
    // Toast megjelen√≠t√©se (implement√°ci√≥ a main.js-ben)
    if (window.showToast) {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}

function showLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}
</script>
{% endblock %}

// Recept kijel√∂l√©se (kattint√°sra)
function selectRecipe(card) {
    // Ne legyen dupla kijel√∂l√©s az √©rt√©kel√©s ut√°n
    if (card.classList.contains('selected')) {
        return;
    }
    
    // Vizu√°lis feedback
    card.classList.toggle('selected');
}

// UI friss√≠t√©se
function updateUI() {
    const ratedCount = Object.keys(ratings).length;
    const canProceed = ratedCount >= requiredRatings;
    
    // Gomb √°llapot√°nak friss√≠t√©se
    const nextBtn = document.getElementById('nextRoundBtn') || document.getElementById('completeStudyBtn');
    if (nextBtn) {
        nextBtn.disabled = !canProceed;
        
        if (canProceed) {
            nextBtn.innerHTML = currentRound < maxRounds ? 
                '<i class="fas fa-arrow-right"></i> K√∂vetkez≈ë K√∂r' :
                '<i class="fas fa-flag-checkered"></i> Tanulm√°ny Befejez√©se';
        } else {
            nextBtn.innerHTML = `<i class="fas fa-hourglass-half"></i> ${ratedCount}/${requiredRatings} √ârt√©kel√©s`;
        }
    }
    
    // St√°tusz friss√≠t√©se
    const statusElement = document.getElementById('ratingStatus');
    if (statusElement) {
        statusElement.textContent = `${ratedCount} / ${requiredRatings} recept √©rt√©kelve`;
    }
}

// K√∂vetkez≈ë k√∂rre l√©p√©s
function advanceToNextRound() {
    if (Object.keys(ratings).length < requiredRatings) {
        showToast(`Legal√°bb ${requiredRatings} recept √©rt√©kel√©se sz√ºks√©ges!`, 'warning');
        return;
    }
    
    showLoading();
    
    fetch('/next_round', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            showToast('K√∂vetkez≈ë k√∂r bet√∂lt√©se...', 'success');
            window.location.href = data.redirect_url || '/';
        } else {
            showToast('Hiba a k√∂vetkez≈ë k√∂rre l√©p√©sben', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('K√∂vetkez≈ë k√∂r hiba:', error);
        showToast('H√°l√≥zati hiba', 'error');
