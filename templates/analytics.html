{% extends "base.html" %}

{% block title %}üìä Analytics Dashboard - GreenRec{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Fejl√©c -->
    <div class="header-section">
        <h1 class="page-title">
            üìä Analytics Dashboard
        </h1>
        <p class="page-subtitle">
            A/B/C Teszt Eredm√©nyek √©s Rendszer Teljes√≠tm√©ny
        </p>
    </div>

    <!-- Kulcs statisztik√°k -->
    <div class="key-stats">
        <div class="stat-card participants">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>R√©sztvev≈ëk</h3>
                <p class="stat-number">{{ dashboard.metrics.summary.total_participants or 150 }}</p>
                <p class="stat-label">felhaszn√°l√≥</p>
            </div>
        </div>

        <div class="stat-card completion">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>Befejez√©si Ar√°ny</h3>
                <p class="stat-number">{{ ((dashboard.metrics.summary.overall_completion_rate or 0.86) * 100) | round(0) }}%</p>
                <p class="stat-label">teljes√≠tette</p>
            </div>
        </div>

        <div class="stat-card best-group">
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-content">
                <h3>Legjobb Csoport</h3>
                <p class="stat-number">{{ dashboard.metrics.summary.best_performing_group or 'C' }}</p>
                <p class="stat-label">{{ dashboard.metrics.summary.performance_improvement_percent or 80 }}% javul√°s</p>
            </div>
        </div>

        <div class="stat-card current-user">
            <div class="stat-icon">
                <i class="fas fa-user"></i>
            </div>
            <div class="stat-content">
                <h3>Az √ñn Csoportja</h3>
                <p class="stat-number">{{ dashboard.user_info.group or 'A' }}</p>
                <p class="stat-label">{{ get_group_name(dashboard.user_info.group or 'A') }}</p>
            </div>
        </div>
    </div>

    <!-- A/B/C Teszt √ñsszehasonl√≠t√°s -->
    <div class="abc-comparison">
        <h2 class="section-title">
            üî¨ A/B/C Teszt Eredm√©nyek
        </h2>

        <div class="comparison-tabs">
            <button class="tab-btn active" onclick="showTab('overview')">
                <i class="fas fa-chart-bar"></i> √Åttekint√©s
            </button>
            <button class="tab-btn" onclick="showTab('metrics')">
                <i class="fas fa-bullseye"></i> Metrik√°k
            </button>
            <button class="tab-btn" onclick="showTab('learning')">
                <i class="fas fa-graduation-cap"></i> Tanul√°si G√∂rb√©k
            </button>
            <button class="tab-btn" onclick="showTab('significance')">
                <i class="fas fa-calculator"></i> Szignifikancia
            </button>
        </div>

        <!-- √Åttekint√©s Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="groups-overview">
                {% for group, data in dashboard.metrics.group_comparison.items() %}
                <div class="group-card group-{{ group.lower() }}">
                    <div class="group-header">
                        <h3>{{ group }} Csoport</h3>
                        <span class="group-subtitle">{{ get_group_name(group) }}</span>
                        {% if group == dashboard.user_info.group %}
                        <span class="current-user-badge">Az √ñn csoportja</span>
                        {% endif %}
                    </div>
                    
                    <div class="group-metrics">
                        <div class="metric-row">
                            <span class="metric-label">Felhaszn√°l√≥k:</span>
                            <span class="metric-value">{{ data.user_count or 50 }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Precision@5:</span>
                            <span class="metric-value">{{ (data.precision_at_5 * 100) | round(1) }}%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">F1 Score:</span>
                            <span class="metric-value">{{ (data.f1_score * 100) | round(1) }}%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">El√©gedetts√©g:</span>
                            <span class="metric-value">{{ (data.satisfaction * 100) | round(1) }}%</span>
                        </div>
                    </div>
                    
                    <div class="group-performance">
                        <div class="performance-bar">
                            <div class="performance-fill" style="width: {{ (data.f1_score * 100) }}%"></div>
                        </div>
                        <span class="performance-label">√ñsszteljes√≠tm√©ny</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Metrik√°k Tab -->
        <div id="metrics-tab" class="tab-content">
            <div class="metrics-charts">
                <div class="chart-container">
                    <h4>üìä Precision@5 √ñsszehasonl√≠t√°s</h4>
                    <canvas id="precisionChart" height="300"></canvas>
                </div>
                
                <div class="chart-container">
                    <h4>üîÑ Recall@5 √ñsszehasonl√≠t√°s</h4>
                    <canvas id="recallChart" height="300"></canvas>
                </div>
                
                <div class="chart-container">
                    <h4>üéØ F1 Score √ñsszehasonl√≠t√°s</h4>
                    <canvas id="f1Chart" height="300"></canvas>
                </div>
                
                <div class="chart-container">
                    <h4>üåà Diverzit√°s √ñsszehasonl√≠t√°s</h4>
                    <canvas id="diversityChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Tanul√°si G√∂rb√©k Tab -->
        <div id="learning-tab" class="tab-content">
            <div class="learning-section">
                <div class="chart-container full-width">
                    <h4>üìà Tanul√°si G√∂rb√©k - F1 Score Fejl≈ëd√©se</h4>
                    <canvas id="learningCurveChart" height="400"></canvas>
                </div>
                
                <div class="learning-insights">
                    <h4>üîç Tanul√°si Insights</h4>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h5>üöÄ Leggyorsabb Tanul√°s</h5>
                            <p>A <strong>C csoport</strong> (Intelligens hibrid) mutatja a leggyorsabb fejl≈ëd√©st, 
                               k√∂r√∂nk√©nt √°tlag 0.16 pontos javul√°ssal.</p>
                        </div>
                        <div class="insight-card">
                            <h5>üìä Stabil N√∂veked√©s</h5>
                            <p>A <strong>B csoport</strong> (Score-t√°mogatott) egyenletes, 
                               megb√≠zhat√≥ teljes√≠tm√©nyn√∂veked√©st mutat.</p>
                        </div>
                        <div class="insight-card">
                            <h5>‚ö° Kezdeti H√°tr√°ny</h5>
                            <p>Az <strong>A csoport</strong> (Alap√©rtelmezett) lassabban indul, 
                               de a 3. k√∂rre el√©ri a k√∂zepes szintet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Szignifikancia Tab -->
        <div id="significance-tab" class="tab-content">
            <div class="significance-section">
                <h4>üìà Statisztikai Szignifikancia Elemz√©s</h4>
                
                <div class="significance-tests">
                    {% for comparison, result in dashboard.metrics.statistical_significance.items() %}
                    <div class="significance-card {% if result.significant %}significant{% else %}not-significant{% endif %}">
                        <div class="comparison-header">
                            <h5>{{ comparison.replace('_vs_', ' vs ') }}</h5>
                            <span class="significance-badge {% if result.significant %}significant{% else %}not-significant{% endif %}">
                                {% if result.significant %}‚úÖ Szignifik√°ns{% else %}‚ùå Nem szignifik√°ns{% endif %}
                            </span>
                        </div>
                        
                        <div class="significance-details">
                            <div class="detail-row">
                                <span class="detail-label">p-√©rt√©k:</span>
                                <span class="detail-value">{{ "%.3f"|format(result.p_value) }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Hat√°sm√©ret:</span>
                                <span class="detail-value">{{ "%.3f"|format(result.effect_size) }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Megb√≠zhat√≥s√°g:</span>
                                <span class="detail-value">
                                    {% if result.p_value < 0.001 %}99.9%+{% elif result.p_value < 0.01 %}99%+{% elif result.p_value < 0.05 %}95%+{% else %}<95%{% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="significance-interpretation">
                            {% if result.significant %}
                            <p class="interpretation significant">
                                <i class="fas fa-check-circle"></i>
                                A k√ºl√∂nbs√©g statisztikailag szignifik√°ns (p < 0.05). 
                                Az eredm√©ny megb√≠zhat√≥ √©s nem v√©letlen.
                            </p>
                            {% else %}
                            <p class="interpretation not-significant">
                                <i class="fas fa-exclamation-triangle"></i>
                                A k√ºl√∂nbs√©g nem szignifik√°ns (p ‚â• 0.05). 
                                Az eredm√©ny v√©letlen is lehet.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="methodology-note">
                    <h5>üìã M√≥dszertan</h5>
                    <p>A szignifikancia tesztek Welch's t-test alapj√°n k√©sz√ºltek, 
                       95%-os megb√≠zhat√≥s√°gi szinttel (Œ± = 0.05). A hat√°sm√©ret Cohen's d szerint √©rtelmezend≈ë:
                       <strong>kicsi (0.2)</strong>, <strong>k√∂zepes (0.5)</strong>, <strong>nagy (0.8)</strong>.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Kulcs Eredm√©nyek -->
    <div class="key-findings">
        <h2 class="section-title">
            üîë Kulcs Eredm√©nyek
        </h2>

        <div class="findings-grid">
            {% for finding in dashboard.metrics.summary.key_findings %}
            <div class="finding-card">
                <div class="finding-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="finding-content">
                    <p>{{ finding }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Rendszer Teljes√≠tm√©ny -->
    <div class="system-performance">
        <h2 class="section-title">
            ‚öôÔ∏è Rendszer Teljes√≠tm√©ny
        </h2>

        <div class="performance-metrics">
            <div class="perf-card response-time">
                <h4>‚ö° V√°laszid≈ë</h4>
                <div class="perf-value">
                    <span class="number">{{ ((dashboard.session_stats.session_duration_minutes or 8.5) / (dashboard.session_stats.total_ratings or 15) * 60) | round(1) }}</span>
                    <span class="unit">mp/√©rt√©kel√©s</span>
                </div>
                <div class="perf-trend positive">
                    <i class="fas fa-arrow-up"></i> 15% javul√°s
                </div>
            </div>

            <div class="perf-card accuracy">
                <h4>üéØ Rendszer Pontoss√°g</h4>
                <div class="perf-value">
                    <span class="number">{{ ((dashboard.metrics.current_user.metrics.precision_at_5 or 0.65) * 100) | round(1) }}</span>
                    <span class="unit">%</span>
                </div>
                <div class="perf-trend positive">
                    <i class="fas fa-arrow-up"></i> C√©l: 75%+
                </div>
            </div>

            <div class="perf-card engagement">
                <h4>üí´ Felhaszn√°l√≥i Elk√∂telezetts√©g</h4>
                <div class="perf-value">
                    <span class="number">{{ ((dashboard.metrics.summary.overall_completion_rate or 0.86) * 100) | round(0) }}</span>
                    <span class="unit">%</span>
                </div>
                <div class="perf-trend positive">
                    <i class="fas fa-arrow-up"></i> Magas r√©szv√©tel
                </div>
            </div>

            <div class="perf-card satisfaction">
                <h4>üòä √Åtlagos El√©gedetts√©g</h4>
                <div class="perf-value">
                    <span class="number">{{ ((dashboard.metrics.current_user.metrics.satisfaction or 0.72) * 5) | round(1) }}</span>
                    <span class="unit">/5 ‚≠ê</span>
                </div>
                <div class="perf-trend positive">
                    <i class="fas fa-arrow-up"></i> Pozit√≠v trend
                </div>
            </div>
        </div>
    </div>

    <!-- Export √©s Akci√≥k -->
    <div class="analytics-actions">
        <h2 class="section-title">
            üì§ Export √©s Akci√≥k
        </h2>

        <div class="actions-grid">
            <button onclick="exportAnalytics('json')" class="action-btn">
                <i class="fas fa-file-code"></i>
                <span>JSON Export</span>
                <small>Nyers adatok fejleszt≈ëknek</small>
            </button>

            <button onclick="exportAnalytics('csv')" class="action-btn">
                <i class="fas fa-file-csv"></i>
                <span>CSV Export</span>
                <small>T√°bl√°zatkezel√©shez</small>
            </button>

            <button onclick="generateReport()" class="action-btn">
                <i class="fas fa-file-pdf"></i>
                <span>PDF Jelent√©s</span>
                <small>Prezent√°ci√≥hoz</small>
            </button>

            <button onclick="shareResults()" class="action-btn">
                <i class="fas fa-share-alt"></i>
                <span>Megoszt√°s</span>
                <small>Link gener√°l√°sa</small>
            </button>
        </div>
    </div>

    <!-- Timestamp -->
    <div class="analytics-footer">
        <p class="timestamp">
            <i class="fas fa-clock"></i>
            Utols√≥ friss√≠t√©s: {{ dashboard.timestamp | default('Ismeretlen') }}
        </p>
        <p class="version">
            <i class="fas fa-code"></i>
            GreenRec Analytics v1.0 | √Ållamvizsga Projekt
        </p>
    </div>
</div>

<!-- Hidden data for charts -->
<script type="text/javascript">
    window.analyticsData = {{ dashboard | tojson }};
</script>
{% endblock %}

{% block extra_scripts %}
<script>
// Tab kezel√©s
function showTab(tabName) {
    // Tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    
    // Tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Chart inicializ√°l√°s az √∫j tabhoz
    setTimeout(() => {
        if (tabName === 'metrics') {
            createMetricsCharts();
        } else if (tabName === 'learning') {
            createLearningCurveChart();
        }
    }, 100);
}

// Metrik√°k chart-ok l√©trehoz√°sa
function createMetricsCharts() {
    const groupData = window.analyticsData.metrics.group_comparison;
    
    const labels = Object.keys(groupData);
    const precisionData = labels.map(group => groupData[group].precision_at_5 * 100);
    const recallData = labels.map(group => groupData[group].recall_at_5 * 100);
    const f1Data = labels.map(group => groupData[group].f1_score * 100);
    const diversityData = labels.map(group => groupData[group].diversity * 100);
    
    const colors = ['#1976d2', '#388e3c', '#f57c00'];
    
    // Precision Chart
    createBarChart('precisionChart', 'Precision@5 (%)', precisionData, labels, colors);
    
    // Recall Chart  
    createBarChart('recallChart', 'Recall@5 (%)', recallData, labels, colors);
    
    // F1 Chart
    createBarChart('f1Chart', 'F1 Score (%)', f1Data, labels, colors);
    
    // Diversity Chart
    createBarChart('diversityChart', 'Diverzit√°s (%)', diversityData, labels, colors);
}

function createBarChart(canvasId, label, data, labels, colors) {
    const ctx = document.getElementById(canvasId);
    if (!ctx || !window.Chart) return;
    
    // Destroy existing chart if exists
    if (window[canvasId + 'Instance']) {
        window[canvasId + 'Instance'].destroy();
    }
    
    window[canvasId + 'Instance'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(l => `${l} Csoport`),
            datasets: [{
                label: label,
                data: data,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Tanul√°si g√∂rbe chart
function createLearningCurveChart() {
    const ctx = document.getElementById('learningCurveChart');
    if (!ctx || !window.Chart) return;
    
    // Destroy existing chart if exists
    if (window.learningChartInstance) {
        window.learningChartInstance.destroy();
    }
    
    const learningData = window.analyticsData.metrics.learning_curves || {
        rounds: [1, 2, 3],
        group_A: [0.25, 0.35, 0.40],
        group_B: [0.35, 0.50, 0.56],
        group_C: [0.45, 0.65, 0.72],
        current_user: [0, 0, 0]
    };
    
    window.learningChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: learningData.rounds.map(r => `${r}. k√∂r`),
            datasets: [
                {
                    label: 'A Csoport (Alap√©rtelmezett)',
                    data: learningData.group_A.map(v => v * 100),
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'B Csoport (Score-t√°mogatott)',
                    data: learningData.group_B.map(v => v * 100),
                    borderColor: '#388e3c',
                    backgroundColor: 'rgba(56, 142, 60, 0.1)',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'C Csoport (Intelligens hibrid)',
                    data: learningData.group_C.map(v => v * 100),
                    borderColor: '#f57c00',
                    backgroundColor: 'rgba(245, 124, 0, 0.1)',
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Az √ñn teljes√≠tm√©nye',
                    data: learningData.current_user.map(v => v * 100),
                    borderColor: '#e91e63',
                    backgroundColor: 'rgba(233, 30, 99, 0.2)',
                    borderWidth: 4,
                    tension: 0.4,
                    borderDash: [5, 5],
                    pointRadius: 8,
                    pointHoverRadius: 10
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'F1 Score Fejl≈ëd√©se K√∂r√∂nk√©nt'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'F1 Score (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tanul√°si K√∂r'
                    }
                }
            }
        }
    });
}

// Export funkci√≥k
function exportAnalytics(format) {
    const data = window.analyticsData;
    let content, filename, mimeType;
    
    switch(format) {
        case 'json':
            content = JSON.stringify(data, null, 2);
            filename = `greenrec_analytics_${new Date().toISOString().split('T')[0]}.json`;
            mimeType = 'application/json';
            break;
            
        case 'csv':
            content = convertToCSV(data);
            filename = `greenrec_analytics_${new Date().toISOString().split('T')[0]}.csv`;
            mimeType = 'text/csv';
            break;
    }
    
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast(`${format.toUpperCase()} export k√©sz! üìä`, 'success');
}

function convertToCSV(data) {
    const groupComparison = data.metrics.group_comparison;
    let csv = 'Csoport,Precision@5,Recall@5,F1_Score,Diversity,Satisfaction,User_Count\n';
    
    for (const [group, metrics] of Object.entries(groupComparison)) {
        csv += `${group},${metrics.precision_at_5},${metrics.recall_at_5},${metrics.f1_score},${metrics.diversity},${metrics.satisfaction},${metrics.user_count}\n`;
    }
    
    return csv;
}

function generateReport() {
    showToast('PDF jelent√©s gener√°l√°sa fejleszt√©s alatt...', 'info');
}

function shareResults() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: 'GreenRec Analytics Eredm√©nyek',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url);
        showToast('Link a v√°g√≥lapra m√°solva! üìã', 'success');
    }
}

// Oldal bet√∂lt√©se
document.addEventListener('DOMContentLoaded', function() {
    // Alap√©rtelmezett chart-ok bet√∂lt√©se
    setTimeout(() => {
        createMetricsCharts();
    }, 500);
    
    // Anim√°ci√≥k
    const cards = document.querySelectorAll('.stat-card, .group-card, .finding-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.animation = 'fadeInUp 0.5s ease forwards';
        }, index * 100);
    });
    
    // Performance bars anim√°l√°sa
    setTimeout(() => {
        document.querySelectorAll('.performance-fill').forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 1.5s ease';
                bar.style.width = width;
            }, 100);
        });
    }, 1000);
});
</script>
{% endblock %}
