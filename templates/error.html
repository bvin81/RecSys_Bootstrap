{% extends "base.html" %}

{% block title %}‚ö†Ô∏è Hiba - GreenRec{% endblock %}

{% block content %}
<div class="container">
    <!-- Fejl√©c -->
    <div class="header-section">
        <h1 class="page-title">
            ‚ö†Ô∏è Rendszerhiba
        </h1>
        <p class="page-subtitle">
            Valami rosszul ment...
        </p>
    </div>

    <!-- Hiba r√©szletek -->
    <div class="error-content">
        <div class="error-main">
            <div class="error-icon">
                {% if error_code == 404 %}
                <i class="fas fa-search fa-4x"></i>
                {% elif error_code == 500 %}
                <i class="fas fa-server fa-4x"></i>
                {% elif error_code == 403 %}
                <i class="fas fa-lock fa-4x"></i>
                {% else %}
                <i class="fas fa-exclamation-triangle fa-4x"></i>
                {% endif %}
            </div>
            
            <div class="error-details">
                <h2 class="error-title">
                    {% if error_code == 404 %}
                    Oldal nem tal√°lhat√≥
                    {% elif error_code == 500 %}
                    Szerver hiba
                    {% elif error_code == 403 %}
                    Hozz√°f√©r√©s megtagadva
                    {% else %}
                    Ismeretlen hiba
                    {% endif %}
                </h2>
                
                <p class="error-code">
                    Hibak√≥d: {{ error_code or '500' }}
                </p>
                
                <p class="error-message">
                    {% if error_message %}
                    {{ error_message }}
                    {% elif error_code == 404 %}
                    A keresett oldal nem tal√°lhat√≥. Lehet, hogy a link elavult vagy hib√°s.
                    {% elif error_code == 500 %}
                    Bels≈ë szerver hiba t√∂rt√©nt. Pr√≥b√°lja √∫jra k√©s≈ëbb.
                    {% elif error_code == 403 %}
                    Nincs jogosults√°ga ehhez az er≈ëforr√°shoz.
                    {% else %}
                    V√°ratlan hiba t√∂rt√©nt a rendszerben.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Javaslatok -->
        <div class="error-suggestions">
            <h3>üí° Mit tehet?</h3>
            <div class="suggestions-grid">
                <div class="suggestion-card">
                    <i class="fas fa-home"></i>
                    <h4>T√©rjen vissza a f≈ëoldalra</h4>
                    <p>Kezdje √∫jra a receptaj√°nl√°si folyamatot</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-home"></i> F≈ëoldal
                    </a>
                </div>

                <div class="suggestion-card">
                    <i class="fas fa-refresh"></i>
                    <h4>Pr√≥b√°lja √∫jra</h4>
                    <p>Friss√≠tse az oldalt vagy pr√≥b√°lja √∫jra a m≈±veletet</p>
                    <button onclick="window.location.reload()" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> √öjrat√∂lt√©s
                    </button>
                </div>

                <div class="suggestion-card">
                    <i class="fas fa-chart-line"></i>
                    <h4>Eredm√©nyek megtekint√©se</h4>
                    <p>N√©zze meg az eddigi eredm√©nyeit</p>
                    <a href="{{ url_for('results') }}" class="btn btn-success">
                        <i class="fas fa-trophy"></i> Eredm√©nyek
                    </a>
                </div>

                <div class="suggestion-card">
                    <i class="fas fa-user-cog"></i>
                    <h4>Session √∫jraind√≠t√°sa</h4>
                    <p>Kezdje √∫jra a teljes tanulm√°nyt</p>
                    <a href="{{ url_for('reset_session') }}" class="btn btn-warning">
                        <i class="fas fa-refresh"></i> √öj kezd√©s
                    </a>
                </div>
            </div>
        </div>

        <!-- Technikai inform√°ci√≥k -->
        <div class="error-technical">
            <h3>üîß Technikai Inform√°ci√≥k</h3>
            <div class="tech-info">
                <div class="tech-row">
                    <span class="tech-label">Id≈ëb√©lyeg:</span>
                    <span class="tech-value">{{ moment().strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </div>
                <div class="tech-row">
                    <span class="tech-label">Hibak√≥d:</span>
                    <span class="tech-value">{{ error_code or 'UNKNOWN' }}</span>
                </div>
                <div class="tech-row">
                    <span class="tech-label">User Agent:</span>
                    <span class="tech-value">{{ request.user_agent.string[:50] }}...</span>
                </div>
                <div class="tech-row">
                    <span class="tech-label">URL:</span>
                    <span class="tech-value">{{ request.url }}</span>
                </div>
                {% if session.user_id %}
                <div class="tech-row">
                    <span class="tech-label">Session ID:</span>
                    <span class="tech-value">{{ session.user_id[:8] }}...</span>
                </div>
                <div class="tech-row">
                    <span class="tech-label">Csoport:</span>
                    <span class="tech-value">{{ session.user_group or 'N/A' }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- T√°mogat√°si inform√°ci√≥k -->
        <div class="support-info">
            <h3>üìû Seg√≠ts√©gre van sz√ºks√©ge?</h3>
            <div class="support-content">
                <p>
                    Ha a probl√©ma tov√°bbra is fenn√°ll, k√©rj√ºk vegye fel a kapcsolatot 
                    a rendszer fejleszt≈ëj√©vel a k√∂vetkez≈ë inform√°ci√≥kkal:
                </p>
                
                <div class="support-details">
                    <div class="support-item">
                        <strong>Hibak√≥d:</strong> {{ error_code or 'UNKNOWN' }}
                    </div>
                    <div class="support-item">
                        <strong>Id≈ëpont:</strong> {{ moment().strftime('%Y-%m-%d %H:%M:%S') }}
                    </div>
                    <div class="support-item">
                        <strong>URL:</strong> {{ request.url }}
                    </div>
                    {% if error_trace %}
                    <div class="support-item">
                        <strong>Trace ID:</strong> {{ error_trace }}
                    </div>
                    {% endif %}
                </div>

                <div class="support-actions">
                    <button onclick="copyErrorInfo()" class="btn btn-outline">
                        <i class="fas fa-copy"></i> Hiba inform√°ci√≥k m√°sol√°sa
                    </button>
                    <a href="mailto:support@greenrec.com?subject=GreenRec Hiba - {{ error_code }}" class="btn btn-info">
                        <i class="fas fa-envelope"></i> Email k√ºld√©se
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden error data -->
<input type="hidden" id="errorData" value="{{ {
    'code': error_code,
    'message': error_message,
    'timestamp': moment().strftime('%Y-%m-%d %H:%M:%S'),
    'url': request.url,
    'user_agent': request.user_agent.string,
    'session_id': session.user_id if session.user_id else 'N/A',
    'user_group': session.user_group if session.user_group else 'N/A'
} | tojson }}">
{% endblock %}

{% block extra_scripts %}
<script>
// Hiba inform√°ci√≥k m√°sol√°sa
function copyErrorInfo() {
    const errorData = JSON.parse(document.getElementById('errorData').value);
    
    const errorText = `
GreenRec Hiba Jelent√©s
=====================
Hibak√≥d: ${errorData.code}
√úzenet: ${errorData.message}
Id≈ëpont: ${errorData.timestamp}
URL: ${errorData.url}
User Agent: ${errorData.user_agent}
Session ID: ${errorData.session_id}
Csoport: ${errorData.user_group}
    `.trim();
    
    navigator.clipboard.writeText(errorText).then(() => {
        showToast('Hiba inform√°ci√≥k a v√°g√≥lapra m√°solva! üìã', 'success');
    }).catch(() => {
        showToast('M√°sol√°s sikertelen', 'error');
    });
}

// Automatikus visszair√°ny√≠t√°s (opcion√°lis)
function autoRedirect() {
    let countdown = 30;
    const redirectBtn = document.getElementById('autoRedirectBtn');
    
    if (redirectBtn) {
        const timer = setInterval(() => {
            countdown--;
            redirectBtn.textContent = `Automatikus √°tir√°ny√≠t√°s ${countdown}s m√∫lva`;
            
            if (countdown <= 0) {
                clearInterval(timer);
                window.location.href = "{{ url_for('index') }}";
            }
        }, 1000);
        
        // Kattint√°sra megszak√≠t√°s
        redirectBtn.addEventListener('click', () => {
            clearInterval(timer);
        });
    }
}

// K√©perny≈ëk√©p k√©sz√≠t√©se hibakeres√©shez
function takeScreenshot() {
    if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
        navigator.mediaDevices.getDisplayMedia({ video: true })
            .then(stream => {
                showToast('K√©perny≈ëk√©p funkci√≥ akt√≠v üì∏', 'info');
                // Itt lehetne implement√°lni a k√©perny≈ëk√©p logik√°t
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(() => {
                showToast('K√©perny≈ëk√©p nem t√°mogatott', 'warning');
            });
    }
}

// Oldal bet√∂lt√©skor
document.addEventListener('DOMContentLoaded', function() {
    // Anim√°ci√≥k
    const cards = document.querySelectorAll('.suggestion-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.animation = 'fadeInUp 0.5s ease forwards';
        }, index * 200);
    });
    
    // Error reporting
    if (window.location.hash === '#auto-redirect') {
        autoRedirect();
    }
    
    // Console log for debugging
    console.error('GreenRec Error Page:', JSON.parse(document.getElementById('errorData').value));
});
</script>

<style>
/* Error oldal specifikus st√≠lusok */
.error-content {
    max-width: 800px;
    margin: 0 auto;
}

.error-main {
    background: var(--white);
    border-radius: var(--radius-xl);
    padding: var(--spacing-2xl);
    text-align: center;
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-lg);
}

.error-icon {
    color: var(--danger-color);
    margin-bottom: var(--spacing-xl);
}

.error-title {
    font-size: var(--font-size-3xl);
    color: var(--black);
    margin-bottom: var(--spacing-md);
}

.error-code {
    font-size: var(--font-size-lg);
    color: var(--danger-color);
    font-weight: bold;
    margin-bottom: var(--spacing-lg);
}

.error-message {
    font-size: var(--font-size-lg);
    color: var(--dark-gray);
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
}

.error-suggestions {
    margin-bottom: var(--spacing-xl);
}

.error-suggestions h3 {
    color: var(--white);
    text-align: center;
    margin-bottom: var(--spacing-xl);
    font-size: var(--font-size-2xl);
}

.suggestions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.suggestion-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    text-align: center;
    box-shadow: var(--shadow-md);
    transition: var(--transition-normal);
}

.suggestion-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.suggestion-card i {
    font-size: var(--font-size-3xl);
    color: var(--primary-color);
    margin-bottom: var(--spacing-lg);
}

.suggestion-card h4 {
    margin-bottom: var(--spacing-md);
    color: var(--black);
}

.suggestion-card p {
    color: var(--dark-gray);
    margin-bottom: var(--spacing-lg);
    font-size: var(--font-size-sm);
}

.error-technical {
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.error-technical h3 {
    color: var(--white);
    margin-bottom: var(--spacing-lg);
}

.tech-info {
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
}

.tech-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--light-gray);
}

.tech-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.tech-label {
    font-weight: bold;
    color: var(--dark-gray);
    min-width: 120px;
}

.tech-value {
    color: var(--black);
    font-family: monospace;
    font-size: var(--font-size-sm);
    text-align: right;
    word-break: break-all;
}

.support-info {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    box-shadow: var(--shadow-md);
}

.support-info h3 {
    color: var(--primary-color);
    margin-bottom: var(--spacing-lg);
}

.support-details {
    background: var(--light-gray);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    margin: var(--spacing-lg) 0;
}

.support-item {
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-sm);
}

.support-item strong {
    color: var(--dark-gray);
    display: inline-block;
    min-width: 80px;
}

.support-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    flex-wrap: wrap;
    margin-top: var(--spacing-lg);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: var(--white);
}

.btn-info {
    background: linear-gradient(45deg, var(--info-color), #1976d2);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .suggestions-grid {
        grid-template-columns: 1fr;
    }
    
    .support-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .tech-row {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }
    
    .tech-value {
        text-align: left;
        word-break: break-word;
    }
    
    .error-main {
        padding: var(--spacing-lg);
    }
}
</style>
{% endblock %}
